# coding=utf-8
import cv2
import numpy as np
import mvsdk
import platform
import datetime  # ç”¨äºç”Ÿæˆå¸¦æ—¶é—´æˆ³çš„æ–‡ä»¶å
import time     # ç”¨äºå¸§ç‡è®¡ç®—


def main_loop():
    # æšä¸¾ç›¸æœº
    DevList = mvsdk.CameraEnumerateDevice()
    nDev = len(DevList)
    if nDev < 1:
        print("No camera was found!")
        return

    for i, DevInfo in enumerate(DevList):
        print("{}: {} {}".format(i, DevInfo.GetFriendlyName(), DevInfo.GetPortType()))
    i = 0 if nDev == 1 else int(input("Select camera: "))
    DevInfo = DevList[i]
    print(DevInfo)

    # æ‰“å¼€ç›¸æœº
    hCamera = 0
    try:
        hCamera = mvsdk.CameraInit(DevInfo, -1, -1)
    except mvsdk.CameraException as e:
        print("CameraInit Failed({}): {}".format(e.error_code, e.message))
        return

    # è·å–ç›¸æœºç‰¹æ€§æè¿°
    cap = mvsdk.CameraGetCapability(hCamera)

    # åˆ¤æ–­æ˜¯é»‘ç™½ç›¸æœºè¿˜æ˜¯å½©è‰²ç›¸æœº
    monoCamera = (cap.sIspCapacity.bMonoSensor != 0)

    # é»‘ç™½ç›¸æœºè®©ISPç›´æ¥è¾“å‡ºMONOæ•°æ®
    if monoCamera:
        mvsdk.CameraSetIspOutFormat(hCamera, mvsdk.CAMERA_MEDIA_TYPE_MONO8)
    else:
        mvsdk.CameraSetIspOutFormat(hCamera, mvsdk.CAMERA_MEDIA_TYPE_BGR8)

    # ==================== æ–°å¢ä»£ç ï¼šè®¾ç½®å¸§ç‡æ¨¡å¼ ====================
    # æ£€æŸ¥å¹¶æ‰“å°æ”¯æŒçš„å¸§ç‡æ¨¡å¼
    if cap.iFrameSpeedDesc > 0:
        print(f"\n[Info] ç›¸æœºæ”¯æŒ {cap.iFrameSpeedDesc} ç§å¸§ç‡æ¨¡å¼:")
        for i in range(cap.iFrameSpeedDesc):
            # è¿™é‡Œçš„ pFrameSpeedDesc æ˜¯ ctypes æŒ‡é’ˆæ•°ç»„ï¼Œå¯ä»¥é€šè¿‡ä¸‹æ ‡è®¿é—®
            desc = cap.pFrameSpeedDesc[i].GetDescription()
            print(f"  æ¨¡å¼ [{i}]: {desc}")
        
        # è®¾ç½®ä¸ºç´¢å¼•æœ€å¤§çš„æ¨¡å¼ï¼ˆé€šå¸¸æ˜¯é«˜é€Ÿæ¨¡å¼ï¼‰
        # å¦‚æœéœ€è¦ç‰¹å®šæ¨¡å¼ï¼Œä¾‹å¦‚æ™®é€šæ¨¡å¼ï¼Œå¯ä»¥æ‰‹åŠ¨è®¾ç½®ä¸º 1
        target_speed_index = cap.iFrameSpeedDesc - 1
        mvsdk.CameraSetFrameSpeed(hCamera, target_speed_index)
        print(f"[Info] å·²è°ƒç”¨ CameraSetFrameSpeed è®¾ç½®ä¸ºæ¨¡å¼: {target_speed_index}\n")
    # ==============================================================

    # ç›¸æœºæ¨¡å¼åˆ‡æ¢æˆè¿ç»­é‡‡é›†
    mvsdk.CameraSetTriggerMode(hCamera, 0)

    # æ‰‹åŠ¨æ›å…‰ï¼Œæ›å…‰æ—¶é—´20ms
#    mvsdk.CameraSetAeState(hCamera, 0)
#    mvsdk.CameraSetExposureTime(hCamera, 20 * 1000)
# ===== è‡ªåŠ¨æ›å…‰é…ç½® =====
    mvsdk.CameraSetAeState(hCamera, 1)
    # ç™½å¹³è¡¡
    mvsdk.CameraSetOnceWB(hCamera)

    # è®©SDKå†…éƒ¨å–å›¾çº¿ç¨‹å¼€å§‹å·¥ä½œ
    mvsdk.CameraPlay(hCamera)

    # è®¡ç®—bufferå¤§å°
    FrameBufferSize = cap.sResolutionRange.iWidthMax * \
        cap.sResolutionRange.iHeightMax * (1 if monoCamera else 3)

    # åˆ†é…RGB buffer
    pFrameBuffer = mvsdk.CameraAlignMalloc(FrameBufferSize, 16)

    # ==================== æ–°å¢ï¼šè§†é¢‘å½•åˆ¶ç›¸å…³å˜é‡ ====================
    is_recording = False                      # æ˜¯å¦æ­£åœ¨å½•åˆ¶
    video_writer = None                       # OpenCVè§†é¢‘å†™å…¥å¯¹è±¡
    output_filename = ""                      # è¾“å‡ºè§†é¢‘æ–‡ä»¶å
    
    # ==================== æ–°å¢ï¼šå¸§ç‡è®¡ç®—ç›¸å…³å˜é‡ ====================
    fps_counter = 0                           # å¸§è®¡æ•°å™¨
    fps_start_time = time.time()              # å¸§ç‡è®¡ç®—å¼€å§‹æ—¶é—´
    current_fps = 0                           # å½“å‰å¸§ç‡
    # ================================================================
    
    # å®šä¹‰å¤„ç†åˆ†è¾¨ç‡å’Œæ˜¾ç¤ºçª—å£å¤§å°
    PROCESS_RESOLUTION = (2048, 1080)  # å¤„ç†åˆ†è¾¨ç‡
    DISPLAY_SIZE = (640, 480)         # æ˜¾ç¤ºçª—å£å¤§å°ï¼Œå¯ä»¥æ ¹æ®éœ€è¦è°ƒæ•´

    while (cv2.waitKey(1) & 0xFF) != ord('q'):
        try:
            pRawData, FrameHead = mvsdk.CameraGetImageBuffer(hCamera, 200)
            mvsdk.CameraImageProcess(
                hCamera, pRawData, pFrameBuffer, FrameHead)
            mvsdk.CameraReleaseImageBuffer(hCamera, pRawData)

            if platform.system() == "Windows":
                mvsdk.CameraFlipFrameBuffer(pFrameBuffer, FrameHead, 1)

            # è½¬æ¢ä¸ºnumpyæ•°ç»„
            frame_data = (mvsdk.c_ubyte *
                          FrameHead.uBytes).from_address(pFrameBuffer)
            frame = np.frombuffer(frame_data, dtype=np.uint8)
            frame = frame.reshape((FrameHead.iHeight, FrameHead.iWidth,
                                  1 if FrameHead.uiMediaType == mvsdk.CAMERA_MEDIA_TYPE_MONO8 else 3))

            # ä¿®æ”¹è¿™é‡Œï¼šè°ƒæ•´å¤„ç†åˆ†è¾¨ç‡ï¼Œä½†æ˜¾ç¤ºæ—¶ç¼©å°
            high_res_frame = cv2.resize(
                frame, PROCESS_RESOLUTION, interpolation=cv2.INTER_LINEAR)
            display_frame = cv2.resize(
                high_res_frame, DISPLAY_SIZE, interpolation=cv2.INTER_LINEAR)
            
            # ==================== æ–°å¢ï¼šå¸§ç‡è®¡ç®—å’Œæ˜¾ç¤º ====================
            fps_counter += 1
            current_time = time.time()
            elapsed_time = current_time - fps_start_time
            
            # æ¯ç§’æ›´æ–°ä¸€æ¬¡å¸§ç‡
            if elapsed_time >= 1.0:
                current_fps = fps_counter / elapsed_time
                fps_counter = 0
                fps_start_time = current_time
            
            # åœ¨ç”»é¢ä¸Šæ˜¾ç¤ºå¸§ç‡å’Œå½•åˆ¶çŠ¶æ€
            fps_text = f"FPS: {current_fps:.1f}"
            cv2.putText(display_frame, fps_text, (10, 30), 
                       cv2.FONT_HERSHEY_SIMPLEX, 0.7, (0, 255, 0), 2)
            
            # æ˜¾ç¤ºå½•åˆ¶çŠ¶æ€
            if is_recording:
                rec_text = "REC"
                cv2.putText(display_frame, rec_text, (DISPLAY_SIZE[0]-80, 30), 
                           cv2.FONT_HERSHEY_SIMPLEX, 0.7, (0, 0, 255), 2)
                # æ·»åŠ çº¢è‰²å½•åˆ¶æŒ‡ç¤ºå™¨
                cv2.circle(display_frame, (DISPLAY_SIZE[0]-40, 20), 8, (0, 0, 255), -1)
            # ================================================================

            cv2.imshow(
                "Press q to end, s to start recording, e to stop", display_frame)

            key = cv2.waitKey(1) & 0xFF
            if key == ord('s'):  # å¼€å§‹å½•åˆ¶
                if not is_recording:
                    timestamp = datetime.datetime.now().strftime("%Y%m%d_%H%M%S")
                    output_filename = f"recording_{timestamp}.mp4"

                    # ä½¿ç”¨é«˜åˆ†è¾¨ç‡ä¿å­˜è§†é¢‘
                    height, width = PROCESS_RESOLUTION[1], PROCESS_RESOLUTION[0]
                    fps = 25

                    fourcc = cv2.VideoWriter_fourcc(*'mp4v')
                    video_writer = cv2.VideoWriter(
                        output_filename, fourcc, fps, (width, height))

                    if video_writer.isOpened():
                        is_recording = True
                        print(
                            f"âœ… å¼€å§‹å½•åˆ¶è§†é¢‘ï¼Œåˆ†è¾¨ç‡: {width}x{height}ï¼Œä¿å­˜ä¸º: {output_filename}")
                    else:
                        print("âŒ æ— æ³•åˆ›å»ºè§†é¢‘æ–‡ä»¶ï¼Œè¯·æ£€æŸ¥è·¯å¾„æˆ–ç¼–ç å™¨ï¼")

            elif key == ord('e'):  # åœæ­¢å½•åˆ¶
                if is_recording:
                    if video_writer is not None:
                        video_writer.release()
                        video_writer = None
                    is_recording = False
                    print("â¹ï¸ åœæ­¢å½•åˆ¶è§†é¢‘")

            elif is_recording:  # å¦‚æœæ­£åœ¨å½•åˆ¶ï¼Œå†™å…¥é«˜åˆ†è¾¨ç‡å¸§
                if video_writer is not None and video_writer.isOpened():
                    video_writer.write(high_res_frame)

        except mvsdk.CameraException as e:
            if e.error_code != mvsdk.CAMERA_STATUS_TIME_OUT:
                print("CameraGetImageBuffer failed({}): {}".format(
                    e.error_code, e.message))

    # é‡Šæ”¾èµ„æº
    if is_recording:
        if video_writer is not None:
            video_writer.release()
        is_recording = False
        print("ğŸ›‘ ç¨‹åºé€€å‡ºå‰å·²åœæ­¢å½•åˆ¶")

    mvsdk.CameraUnInit(hCamera)
    mvsdk.CameraAlignFree(pFrameBuffer)


def main():
    try:
        main_loop()
    finally:
        cv2.destroyAllWindows()


main()
