# coding=utf-8
import cv2
import numpy as np
import mvsdk
import platform
import datetime  # ç”¨äºç”Ÿæˆå¸¦æ—¶é—´æˆ³çš„æ–‡ä»¶å
import time     # ç”¨äºå¸§ç‡è®¡ç®—


def main_loop():
    # æšä¸¾ç›¸æœº
    DevList = mvsdk.CameraEnumerateDevice()
    nDev = len(DevList)
    if nDev < 1:
        print("No camera was found!")
        return

    for i, DevInfo in enumerate(DevList):
        print("{}: {} {}".format(i, DevInfo.GetFriendlyName(), DevInfo.GetPortType()))
    i = 0 if nDev == 1 else int(input("Select camera: "))
    DevInfo = DevList[i]
    print(DevInfo)

    # æ‰“å¼€ç›¸æœº
    hCamera = 0
    try:
        hCamera = mvsdk.CameraInit(DevInfo, -1, -1)
    except mvsdk.CameraException as e:
        print("CameraInit Failed({}): {}".format(e.error_code, e.message))
        return

    # è·å–ç›¸æœºç‰¹æ€§æè¿°
    cap = mvsdk.CameraGetCapability(hCamera)

    # åˆ¤æ–­æ˜¯é»‘ç™½ç›¸æœºè¿˜æ˜¯å½©è‰²ç›¸æœº
    monoCamera = (cap.sIspCapacity.bMonoSensor != 0)

    # é»‘ç™½ç›¸æœºè®©ISPç›´æ¥è¾“å‡ºMONOæ•°æ®
    if monoCamera:
        mvsdk.CameraSetIspOutFormat(hCamera, mvsdk.CAMERA_MEDIA_TYPE_MONO8)
    else:
        mvsdk.CameraSetIspOutFormat(hCamera, mvsdk.CAMERA_MEDIA_TYPE_BGR8)

    # ==================== ã€ä¿®æ”¹1ã€‘é™ä½åˆ†è¾¨ç‡ä»¥æ¢å–å¸§ç‡ ====================
    # 1600ä¸‡åƒç´ å…¨åˆ†è¾¨ç‡ä¸‹ï¼Œç‰©ç†ä¼ è¾“æé™å¯èƒ½åªæœ‰ 15FPS å·¦å³ã€‚
    # å¿…é¡»é€šè¿‡ Skip æˆ– Binning é™ä½åˆ†è¾¨ç‡æ‰èƒ½è·å¾—é«˜å¸§ç‡ã€‚
    
    pImageResolution = mvsdk.CameraGetImageResolution(hCamera)
    is_resolution_reduced = False

    # ä¼˜å…ˆå°è¯• Skip æ¨¡å¼ (æŠ½æ ·)ï¼Œé€šå¸¸å¸§ç‡æå‡æœ€æ˜æ˜¾
    if cap.sResolutionRange.uSkipModeMask & 1: 
        pImageResolution.uSkipMode = 1  # 1 è¡¨ç¤º 2x2 Skip
        mvsdk.CameraSetImageResolution(hCamera, pImageResolution)
        print("âœ… [ç­–ç•¥] å·²å¼€å¯ 2x2 Skip æ¨¡å¼ (åˆ†è¾¨ç‡ 1/4)")
        is_resolution_reduced = True
        
    # å…¶æ¬¡å°è¯• Binning Sum (æ±‚å’Œ)ï¼Œä¼šå˜äº®ä¸”æå‡å¸§ç‡
    elif cap.sResolutionRange.uBinSumModeMask & 1:
        pImageResolution.uBinSumMode = 1
        mvsdk.CameraSetImageResolution(hCamera, pImageResolution)
        print("âœ… [ç­–ç•¥] å·²å¼€å¯ 2x2 Binning Sum æ¨¡å¼")
        is_resolution_reduced = True
        
    # å†æ¬¡å°è¯• Binning Average (æ±‚å‡å€¼)
    elif cap.sResolutionRange.uBinAverageModeMask & 1:
        pImageResolution.uBinAverageMode = 1
        mvsdk.CameraSetImageResolution(hCamera, pImageResolution)
        print("âœ… [ç­–ç•¥] å·²å¼€å¯ 2x2 Binning Avg æ¨¡å¼")
        is_resolution_reduced = True
    else:
        print("âš ï¸ [è­¦å‘Š] ç›¸æœºä¸æ”¯æŒç¡¬ä»¶é™é‡‡æ ·ï¼Œå¸§ç‡å¯èƒ½å—é™äºUSBå¸¦å®½æˆ–ä¼ æ„Ÿå™¨è¯»å‡ºé€Ÿåº¦")

    # ==================== ã€ä¿®æ”¹2ã€‘è®¾ç½®æœ€é«˜é€Ÿæ¨¡å¼ ====================
    if cap.iFrameSpeedDesc > 0:
        target_speed_index = cap.iFrameSpeedDesc - 1
        desc = cap.pFrameSpeedDesc[target_speed_index].GetDescription()
        mvsdk.CameraSetFrameSpeed(hCamera, target_speed_index)
        print(f"âœ¨ [ç­–ç•¥] è®¾ç½®åƒç´ æ—¶é’Ÿä¸ºé«˜é€Ÿæ¨¡å¼: {desc} (Index: {target_speed_index})")

    # ç›¸æœºæ¨¡å¼åˆ‡æ¢æˆè¿ç»­é‡‡é›†
    mvsdk.CameraSetTriggerMode(hCamera, 0)

    # ==================== ã€ä¿®æ”¹3ã€‘è‡ªåŠ¨æ›å…‰é™åˆ¶ ====================
    mvsdk.CameraSetAeState(hCamera, 1)
    
    # é™åˆ¶æœ€å¤§æ›å…‰æ—¶é—´ä¸º 30ms (ä¿è¯ç†è®ºå¸§ç‡ > 33 FPS)
    # å¦‚æœæ‚¨çš„ç¯å¢ƒå…‰å¾ˆäº®ï¼Œå¯ä»¥è¿›ä¸€æ­¥é™ä½è¿™ä¸ªå€¼ï¼Œä¾‹å¦‚ 15000 (15ms)
    MAX_EXPOSURE_TIME_US = 30 * 1000 
    mvsdk.CameraSetAeExposureRange(hCamera, 200, MAX_EXPOSURE_TIME_US)
    
    # æé«˜å¢ç›Šä¸Šé™ï¼Œè¡¥å¿çŸ­æ›å…‰å¸¦æ¥çš„å˜æš—
    max_gain = min(32, cap.sExposeDesc.uiAnalogGainMax) 
    mvsdk.CameraSetAeAnalogGainRange(hCamera, cap.sExposeDesc.uiAnalogGainMin, max_gain)
    mvsdk.CameraSetAeTarget(hCamera, 120) # ç›®æ ‡äº®åº¦
    
    # ç™½å¹³è¡¡
    mvsdk.CameraSetOnceWB(hCamera)

    # è®©SDKå†…éƒ¨å–å›¾çº¿ç¨‹å¼€å§‹å·¥ä½œ
    mvsdk.CameraPlay(hCamera)

    # é‡æ–°è·å–åˆ†è¾¨ç‡ï¼ˆå› ä¸ºä¸Šé¢å¯èƒ½ä¿®æ”¹äº†ï¼‰
    final_res = mvsdk.CameraGetImageResolution(hCamera)
    print(f"ğŸ“· æœ€ç»ˆè¾“å‡ºåˆ†è¾¨ç‡: {final_res.iWidth} x {final_res.iHeight}")

    # è®¡ç®—bufferå¤§å°
    FrameBufferSize = cap.sResolutionRange.iWidthMax * \
        cap.sResolutionRange.iHeightMax * (1 if monoCamera else 3)

    # åˆ†é…RGB buffer
    pFrameBuffer = mvsdk.CameraAlignMalloc(FrameBufferSize, 16)

    # å½•åƒå˜é‡
    is_recording = False
    video_writer = None
    
    # å¸§ç‡å˜é‡
    fps_counter = 0
    fps_start_time = time.time()
    current_fps = 0
    
    # å¤„ç†å’Œæ˜¾ç¤º
    PROCESS_RESOLUTION = (1920, 1080) # é™ä½å¤„ç†åˆ†è¾¨ç‡ä»¥å‡è½»Jetson CPUè´Ÿæ‹…
    DISPLAY_SIZE = (640, 480)

    while (cv2.waitKey(1) & 0xFF) != ord('q'):
        try:
            pRawData, FrameHead = mvsdk.CameraGetImageBuffer(hCamera, 200)
            
            mvsdk.CameraImageProcess(hCamera, pRawData, pFrameBuffer, FrameHead)
            mvsdk.CameraReleaseImageBuffer(hCamera, pRawData)

            if platform.system() == "Windows":
                mvsdk.CameraFlipFrameBuffer(pFrameBuffer, FrameHead, 1)

            frame_data = (mvsdk.c_ubyte * FrameHead.uBytes).from_address(pFrameBuffer)
            frame = np.frombuffer(frame_data, dtype=np.uint8)
            frame = frame.reshape((FrameHead.iHeight, FrameHead.iWidth,
                                  1 if FrameHead.uiMediaType == mvsdk.CAMERA_MEDIA_TYPE_MONO8 else 3))

            # ç¼©æ”¾
            high_res_frame = cv2.resize(frame, PROCESS_RESOLUTION, interpolation=cv2.INTER_LINEAR)
            display_frame = cv2.resize(high_res_frame, DISPLAY_SIZE, interpolation=cv2.INTER_LINEAR)
            
            # è®¡ç®—å¸§ç‡
            fps_counter += 1
            current_time = time.time()
            elapsed_time = current_time - fps_start_time
            
            if elapsed_time >= 1.0:
                current_fps = fps_counter / elapsed_time
                fps_counter = 0
                fps_start_time = current_time
                # æ‰“å°è°ƒè¯•
                curr_exp = mvsdk.CameraGetExposureTime(hCamera) / 1000.0
                print(f"FPS: {current_fps:.1f} | Exp: {curr_exp:.1f}ms | Res: {FrameHead.iWidth}x{FrameHead.iHeight}")
            
            # æ˜¾ç¤º
            fps_text = f"FPS: {current_fps:.1f}"
            cv2.putText(display_frame, fps_text, (10, 30), cv2.FONT_HERSHEY_SIMPLEX, 0.7, (0, 255, 0), 2)
            
            if is_recording:
                cv2.putText(display_frame, "REC", (DISPLAY_SIZE[0]-80, 30), cv2.FONT_HERSHEY_SIMPLEX, 0.7, (0, 0, 255), 2)
                cv2.circle(display_frame, (DISPLAY_SIZE[0]-40, 20), 8, (0, 0, 255), -1)

            cv2.imshow("Press q:Exit s:Rec e:Stop", display_frame)

            key = cv2.waitKey(1) & 0xFF
            if key == ord('s'):
                if not is_recording:
                    timestamp = datetime.datetime.now().strftime("%Y%m%d_%H%M%S")
                    output_filename = f"recording_{timestamp}.mp4"
                    height, width = PROCESS_RESOLUTION[1], PROCESS_RESOLUTION[0]
                    rec_fps = max(20, int(current_fps))
                    fourcc = cv2.VideoWriter_fourcc(*'mp4v')
                    video_writer = cv2.VideoWriter(output_filename, fourcc, rec_fps, (width, height))
                    if video_writer.isOpened():
                        is_recording = True
                        print(f"âœ… å¼€å§‹å½•åˆ¶: {output_filename}")

            elif key == ord('e'):
                if is_recording:
                    if video_writer: video_writer.release()
                    video_writer = None
                    is_recording = False
                    print("â¹ï¸ åœæ­¢å½•åˆ¶")

            elif is_recording and video_writer:
                video_writer.write(high_res_frame)

        except mvsdk.CameraException as e:
            if e.error_code != mvsdk.CAMERA_STATUS_TIME_OUT:
                print("Error: {}".format(e.message))

    if is_recording and video_writer:
        video_writer.release()

    mvsdk.CameraUnInit(hCamera)
    mvsdk.CameraAlignFree(pFrameBuffer)

def main():
    try:
        main_loop()
    finally:
        cv2.destroyAllWindows()

if __name__ == "__main__":
    main()
