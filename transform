# coding=utf-8
import cv2
import numpy as np
import mvsdk
import platform
import datetime  # ç”¨äºç”Ÿæˆå¸¦æ—¶é—´æˆ³çš„æ–‡ä»¶å
import time     # ç”¨äºå¸§ç‡è®¡ç®—


def main_loop():
    # æšä¸¾ç›¸æœº
    DevList = mvsdk.CameraEnumerateDevice()
    nDev = len(DevList)
    if nDev < 1:
        print("No camera was found!")
        return

    for i, DevInfo in enumerate(DevList):
        print("{}: {} {}".format(i, DevInfo.GetFriendlyName(), DevInfo.GetPortType()))
    i = 0 if nDev == 1 else int(input("Select camera: "))
    DevInfo = DevList[i]
    print(DevInfo)

    # æ‰“å¼€ç›¸æœº
    hCamera = 0
    try:
        hCamera = mvsdk.CameraInit(DevInfo, -1, -1)
    except mvsdk.CameraException as e:
        print("CameraInit Failed({}): {}".format(e.error_code, e.message))
        return

    # è·å–ç›¸æœºç‰¹æ€§æè¿°
    cap = mvsdk.CameraGetCapability(hCamera)

    # åˆ¤æ–­æ˜¯é»‘ç™½ç›¸æœºè¿˜æ˜¯å½©è‰²ç›¸æœº
    monoCamera = (cap.sIspCapacity.bMonoSensor != 0)

    # é»‘ç™½ç›¸æœºè®©ISPç›´æ¥è¾“å‡ºMONOæ•°æ®
    if monoCamera:
        mvsdk.CameraSetIspOutFormat(hCamera, mvsdk.CAMERA_MEDIA_TYPE_MONO8)
    else:
        mvsdk.CameraSetIspOutFormat(hCamera, mvsdk.CAMERA_MEDIA_TYPE_BGR8)

    # ==================== ã€å…³é”®ä¿®æ”¹1ã€‘è®¾ç½®æœ€é«˜é€Ÿå¸§ç‡æ¨¡å¼ ====================
    # å¾ˆå¤šå·¥ä¸šç›¸æœºé»˜è®¤å¤„äºâ€œæ™®é€šâ€æˆ–â€œä½é€Ÿâ€æ¨¡å¼ä»¥ä¿è¯ç”»è´¨ã€‚
    # è¿™é‡Œæˆ‘ä»¬éå†å¹¶å°†ç›¸æœºçš„å¸§ç‡æ¨¡å¼è®¾ç½®ä¸ºæ”¯æŒåˆ—è¡¨ä¸­çš„æœ€åä¸€é¡¹ï¼ˆé€šå¸¸æ˜¯é«˜é€Ÿæ¨¡å¼ï¼‰ã€‚
    if cap.iFrameSpeedDesc > 0:
        # è·å–æœ€å¤§æ¨¡å¼ç´¢å¼• (é€šå¸¸ç´¢å¼•è¶Šå¤§ï¼Œé€Ÿåº¦è¶Šå¿«)
        target_speed_index = cap.iFrameSpeedDesc - 1
        # è·å–æè¿°æ–‡æœ¬
        speed_desc = cap.pFrameSpeedDesc[target_speed_index].GetDescription()
        print(f"âœ¨ æ­£åœ¨è®¾ç½®å¸§ç‡æ¨¡å¼ä¸º: {speed_desc} (Index: {target_speed_index})")
        
        # è®¾ç½®å¸§ç‡æ¨¡å¼
        mvsdk.CameraSetFrameSpeed(hCamera, target_speed_index)
    # ========================================================================

    # ç›¸æœºæ¨¡å¼åˆ‡æ¢æˆè¿ç»­é‡‡é›†
    mvsdk.CameraSetTriggerMode(hCamera, 0)

    # ==================== ã€å…³é”®ä¿®æ”¹2ã€‘ä¼˜åŒ–æ›å…‰ä»¥æå‡å¸§ç‡ ====================
    # å¼€å¯è‡ªåŠ¨æ›å…‰
    mvsdk.CameraSetAeState(hCamera, 1)
    
    # --- æ ¸å¿ƒæ­¥éª¤ï¼šé™åˆ¶æœ€å¤§æ›å…‰æ—¶é—´ ---
    # å¦‚æœç¯å¢ƒå…‰è¾ƒæš—ï¼Œç›¸æœºå¯èƒ½ä¼šæŠŠæ›å…‰æ—¶é—´æ‹‰é•¿åˆ° 40ms-100msï¼Œå¯¼è‡´å¸§ç‡æ‰åˆ° 25FPS ç”šè‡³ 10FPSã€‚
    # è¿™é‡Œæˆ‘ä»¬å¼ºåˆ¶é™åˆ¶æœ€å¤§æ›å…‰æ—¶é—´ä¸º 30ms (30000å¾®ç§’)ï¼Œç†è®ºæœ€å¤§å¸§ç‡å¯ä¿åº• 33 FPSã€‚
    # å¦‚æœæ‚¨éœ€è¦ 60FPSï¼Œè¯·å°†æ­¤å€¼æ”¹ä¸º 16000 (16ms)ã€‚
    MAX_EXPOSURE_TIME_US = 30 * 1000  # 30ms
    mvsdk.CameraSetAeExposureRange(hCamera, 200, MAX_EXPOSURE_TIME_US)
    print(f"ğŸš€ å·²é™åˆ¶è‡ªåŠ¨æ›å…‰æœ€å¤§æ—¶é—´ä¸º: {MAX_EXPOSURE_TIME_US/1000} ms (ä»¥ä¿è¯è‡³å°‘ {1000/(MAX_EXPOSURE_TIME_US/1000):.1f} FPS)")

    # --- é…å¥—æ­¥éª¤ï¼šæé«˜æ¨¡æ‹Ÿå¢ç›Šä¸Šé™ ---
    # å› ä¸ºé™åˆ¶äº†æ›å…‰æ—¶é—´ï¼Œç”»é¢å¯èƒ½ä¼šå˜æš—ã€‚
    # æˆ‘ä»¬éœ€è¦å…è®¸ç›¸æœºä½¿ç”¨æ›´é«˜çš„æ¨¡æ‹Ÿå¢ç›Šæ¥æäº®ç”»é¢ã€‚
    # é€šå¸¸å¢ç›ŠèŒƒå›´æ˜¯ 16 ~ 64 æˆ–æ›´é«˜ï¼Œè¿™é‡Œè®¾ä¸ºæœ€å¤§å€¼çš„ä¸€åŠä½œä¸ºä¸Šé™ï¼Œé˜²æ­¢å™ªç‚¹è¿‡å¤šã€‚
    max_gain = min(32, cap.sExposeDesc.uiAnalogGainMax) 
    mvsdk.CameraSetAeAnalogGainRange(hCamera, cap.sExposeDesc.uiAnalogGainMin, max_gain)
    
    # è®¾ç½®è‡ªåŠ¨æ›å…‰ç›®æ ‡äº®åº¦ (èŒƒå›´é€šå¸¸ 0~255ï¼Œé»˜è®¤ 120 å·¦å³)
    mvsdk.CameraSetAeTarget(hCamera, 120)
    # ========================================================================

    # ç™½å¹³è¡¡
    mvsdk.CameraSetOnceWB(hCamera)

    # è®©SDKå†…éƒ¨å–å›¾çº¿ç¨‹å¼€å§‹å·¥ä½œ
    mvsdk.CameraPlay(hCamera)

    # è®¡ç®—bufferå¤§å°
    FrameBufferSize = cap.sResolutionRange.iWidthMax * \
        cap.sResolutionRange.iHeightMax * (1 if monoCamera else 3)

    # åˆ†é…RGB buffer
    pFrameBuffer = mvsdk.CameraAlignMalloc(FrameBufferSize, 16)

    # è§†é¢‘å½•åˆ¶ç›¸å…³
    is_recording = False
    video_writer = None
    output_filename = ""
    
    # å¸§ç‡è®¡ç®—
    fps_counter = 0
    fps_start_time = time.time()
    current_fps = 0
    
    # å¤„ç†å’Œæ˜¾ç¤ºå°ºå¯¸
    PROCESS_RESOLUTION = (2048, 1080)
    DISPLAY_SIZE = (640, 480)

    print("\nğŸ”´ æç¤º: å¦‚æœå¸§ç‡ä»ç„¶å¾ˆä½ï¼Œè¯·å°è¯•å¢åŠ ç¯å¢ƒå…‰äº®åº¦ï¼Œæˆ–è€…æ‰‹åŠ¨å°†æ›å…‰æ—¶é—´è®¾ç½®å¾—æ›´çŸ­ã€‚\n")

    while (cv2.waitKey(1) & 0xFF) != ord('q'):
        try:
            # è·å–å›¾åƒï¼Œè¶…æ—¶æ—¶é—´è®¾ä¸º 200ms
            pRawData, FrameHead = mvsdk.CameraGetImageBuffer(hCamera, 200)
            
            mvsdk.CameraImageProcess(hCamera, pRawData, pFrameBuffer, FrameHead)
            mvsdk.CameraReleaseImageBuffer(hCamera, pRawData)

            if platform.system() == "Windows":
                mvsdk.CameraFlipFrameBuffer(pFrameBuffer, FrameHead, 1)

            frame_data = (mvsdk.c_ubyte * FrameHead.uBytes).from_address(pFrameBuffer)
            frame = np.frombuffer(frame_data, dtype=np.uint8)
            frame = frame.reshape((FrameHead.iHeight, FrameHead.iWidth,
                                  1 if FrameHead.uiMediaType == mvsdk.CAMERA_MEDIA_TYPE_MONO8 else 3))

            # ç¼©æ”¾å¤„ç†
            high_res_frame = cv2.resize(frame, PROCESS_RESOLUTION, interpolation=cv2.INTER_LINEAR)
            display_frame = cv2.resize(high_res_frame, DISPLAY_SIZE, interpolation=cv2.INTER_LINEAR)
            
            # æ›´æ–°å¸§ç‡
            fps_counter += 1
            current_time = time.time()
            elapsed_time = current_time - fps_start_time
            if elapsed_time >= 1.0:
                current_fps = fps_counter / elapsed_time
                fps_counter = 0
                fps_start_time = current_time
                
                # è°ƒè¯•æ‰“å°ï¼šæŸ¥çœ‹å½“å‰çš„æ›å…‰æ—¶é—´ï¼Œç¡®è®¤æ˜¯å¦è¢«é™åˆ¶ä½äº†
                # (æ³¨æ„ï¼šCameraGetExposureTime è·å–çš„å€¼æ˜¯å¾®ç§’)
                curr_exp = mvsdk.CameraGetExposureTime(hCamera) / 1000.0
                print(f"FPS: {current_fps:.1f} | å½“å‰æ›å…‰æ—¶é—´: {curr_exp:.1f} ms")
            
            # OSD æ˜¾ç¤º
            fps_text = f"FPS: {current_fps:.1f}"
            cv2.putText(display_frame, fps_text, (10, 30), cv2.FONT_HERSHEY_SIMPLEX, 0.7, (0, 255, 0), 2)
            
            if is_recording:
                cv2.putText(display_frame, "REC", (DISPLAY_SIZE[0]-80, 30), cv2.FONT_HERSHEY_SIMPLEX, 0.7, (0, 0, 255), 2)
                cv2.circle(display_frame, (DISPLAY_SIZE[0]-40, 20), 8, (0, 0, 255), -1)

            cv2.imshow("Press q:Exit s:Record e:Stop", display_frame)

            key = cv2.waitKey(1) & 0xFF
            if key == ord('s'):
                if not is_recording:
                    timestamp = datetime.datetime.now().strftime("%Y%m%d_%H%M%S")
                    output_filename = f"recording_{timestamp}.mp4"
                    height, width = PROCESS_RESOLUTION[1], PROCESS_RESOLUTION[0]
                    # ä½¿ç”¨å½“å‰å®é™…å¸§ç‡ä½œä¸ºå½•åƒå¸§ç‡
                    rec_fps = max(20, int(current_fps)) 
                    fourcc = cv2.VideoWriter_fourcc(*'mp4v')
                    video_writer = cv2.VideoWriter(output_filename, fourcc, rec_fps, (width, height))
                    if video_writer.isOpened():
                        is_recording = True
                        print(f"âœ… å¼€å§‹å½•åˆ¶: {output_filename} (FPS: {rec_fps})")
                    else:
                        print("âŒ å½•åˆ¶å¯åŠ¨å¤±è´¥")

            elif key == ord('e'):
                if is_recording:
                    if video_writer: video_writer.release()
                    video_writer = None
                    is_recording = False
                    print("â¹ï¸ å½•åˆ¶åœæ­¢")

            elif is_recording and video_writer:
                video_writer.write(high_res_frame)

        except mvsdk.CameraException as e:
            if e.error_code != mvsdk.CAMERA_STATUS_TIME_OUT:
                print("Error: {}".format(e.message))

    if is_recording and video_writer:
        video_writer.release()
    
    mvsdk.CameraUnInit(hCamera)
    mvsdk.CameraAlignFree(pFrameBuffer)

def main():
    try:
        main_loop()
    finally:
        cv2.destroyAllWindows()

main()
