# coding=utf-8
import cv2
import numpy as np
import mvsdk
import platform
import datetime
import time

def main_loop():
    # æšä¸¾ç›¸æœº
    DevList = mvsdk.CameraEnumerateDevice()
    nDev = len(DevList)
    if nDev < 1:
        print("No camera was found!")
        return

    for i, DevInfo in enumerate(DevList):
        print("{}: {} {}".format(i, DevInfo.GetFriendlyName(), DevInfo.GetPortType()))
    i = 0 if nDev == 1 else int(input("Select camera: "))
    DevInfo = DevList[i]
    print(DevInfo)

    # æ‰“å¼€ç›¸æœº
    hCamera = 0
    try:
        hCamera = mvsdk.CameraInit(DevInfo, -1, -1)
    except mvsdk.CameraException as e:
        print("CameraInit Failed({}): {}".format(e.error_code, e.message))
        return

    # è·å–ç›¸æœºç‰¹æ€§æè¿°
    cap = mvsdk.CameraGetCapability(hCamera)
    monoCamera = (cap.sIspCapacity.bMonoSensor != 0)

    if monoCamera:
        mvsdk.CameraSetIspOutFormat(hCamera, mvsdk.CAMERA_MEDIA_TYPE_MONO8)
    else:
        mvsdk.CameraSetIspOutFormat(hCamera, mvsdk.CAMERA_MEDIA_TYPE_BGR8)

    # ==================== ã€æ ¸å¿ƒä¿®æ”¹ã€‘å¼ºåˆ¶è®¾ç½® ROI (è£å‰ª) ====================
    # æ—¢ç„¶ç¡¬ä»¶ä¸æ”¯æŒ Binningï¼Œä¸ºäº†æé€Ÿï¼Œæˆ‘ä»¬æ‰‹åŠ¨è®¾ç½®ä¸€ä¸ªè¾ƒå°çš„åˆ†è¾¨ç‡ (ROI)
    # åŸå§‹åˆ†è¾¨ç‡ 4096 x 4096 å¤ªå¤§ï¼Œè·‘ä¸åŠ¨ã€‚
    # è¿™é‡Œæˆ‘ä»¬å°†åˆ†è¾¨ç‡è®¾ç½®ä¸º 1920 x 1080 (å±…ä¸­è£å‰ª)
    
    # 1. è·å–å½“å‰åˆ†è¾¨ç‡é…ç½®
    pImageResolution = mvsdk.CameraGetImageResolution(hCamera)
    
    # 2. è®¾ç½®ç›®æ ‡åˆ†è¾¨ç‡ (æ‚¨å¯ä»¥ä¿®æ”¹è¿™é‡Œçš„å€¼ï¼Œæ¯”å¦‚ 2048x2048)
    target_w = 1920
    target_h = 1080
    
    # ç¡®ä¿ä¸è¶…è¿‡ç›¸æœºæœ€å¤§ç‰©ç†åˆ†è¾¨ç‡
    max_w = cap.sResolutionRange.iWidthMax
    max_h = cap.sResolutionRange.iHeightMax
    
    if target_w > max_w: target_w = max_w
    if target_h > max_h: target_h = max_h
    
    # 3. è®¡ç®—å±…ä¸­åç§»é‡
    offset_x = (max_w - target_w) // 2
    offset_y = (max_h - target_h) // 2
    
    # 4. åº”ç”¨è®¾ç½®
    # iIndex = 0xff è¡¨ç¤ºè‡ªå®šä¹‰ ROI æ¨¡å¼
    pImageResolution.iIndex = 0xff 
    pImageResolution.iWidth = target_w
    pImageResolution.iHeight = target_h
    pImageResolution.iWidthFOV = target_w
    pImageResolution.iHeightFOV = target_h
    pImageResolution.iHOffsetFOV = offset_x
    pImageResolution.iVOffsetFOV = offset_y
    
    mvsdk.CameraSetImageResolution(hCamera, pImageResolution)
    print(f"âœ‚ï¸ [ç­–ç•¥] å·²åº”ç”¨ ROI è£å‰ª: {target_w}x{target_h} (å±…ä¸­åç§»: {offset_x},{offset_y})")
    print("   (æ³¨: è§†é‡ä¼šå˜å°ï¼Œä½†è¿™æ˜¯åœ¨è¯¥ç›¸æœºä¸Šæå‡å¸§ç‡çš„å”¯ä¸€åŠæ³•)")
    # ======================================================================

    # è®¾ç½®é«˜é€Ÿæ¨¡å¼
    if cap.iFrameSpeedDesc > 0:
        target_speed_index = cap.iFrameSpeedDesc - 1
        mvsdk.CameraSetFrameSpeed(hCamera, target_speed_index)

    # è¿ç»­é‡‡é›†
    mvsdk.CameraSetTriggerMode(hCamera, 0)

    # è‡ªåŠ¨æ›å…‰é…ç½® (é™åˆ¶æœ€å¤§æ›å…‰æ—¶é—´)
    mvsdk.CameraSetAeState(hCamera, 1)
    # é™åˆ¶æ›å…‰æ—¶é—´ä¸º 30ms
    mvsdk.CameraSetAeExposureRange(hCamera, 200, 30 * 1000)
    # æé«˜å¢ç›Šä¸Šé™
    max_gain = min(64, cap.sExposeDesc.uiAnalogGainMax)
    mvsdk.CameraSetAeAnalogGainRange(hCamera, cap.sExposeDesc.uiAnalogGainMin, max_gain)
    mvsdk.CameraSetAeTarget(hCamera, 120)
    mvsdk.CameraSetOnceWB(hCamera)

    # å¼€å§‹é‡‡é›†
    mvsdk.CameraPlay(hCamera)

    # æœ€ç»ˆç¡®è®¤åˆ†è¾¨ç‡
    final_res = mvsdk.CameraGetImageResolution(hCamera)
    print(f"ğŸ“· æœ€ç»ˆè¾“å‡ºåˆ†è¾¨ç‡: {final_res.iWidth} x {final_res.iHeight}")

    # Buffer è®¡ç®—
    FrameBufferSize = final_res.iWidth * final_res.iHeight * (1 if monoCamera else 3)
    pFrameBuffer = mvsdk.CameraAlignMalloc(FrameBufferSize, 16)

    # å˜é‡åˆå§‹åŒ–
    is_recording = False
    video_writer = None
    fps_counter = 0
    fps_start_time = time.time()
    current_fps = 0
    
    # æ˜¾ç¤ºè®¾ç½®
    DISPLAY_SIZE = (640, 480)

    while (cv2.waitKey(1) & 0xFF) != ord('q'):
        try:
            pRawData, FrameHead = mvsdk.CameraGetImageBuffer(hCamera, 200)
            mvsdk.CameraImageProcess(hCamera, pRawData, pFrameBuffer, FrameHead)
            mvsdk.CameraReleaseImageBuffer(hCamera, pRawData)

            if platform.system() == "Windows":
                mvsdk.CameraFlipFrameBuffer(pFrameBuffer, FrameHead, 1)

            frame_data = (mvsdk.c_ubyte * FrameHead.uBytes).from_address(pFrameBuffer)
            frame = np.frombuffer(frame_data, dtype=np.uint8)
            frame = frame.reshape((FrameHead.iHeight, FrameHead.iWidth,
                                  1 if FrameHead.uiMediaType == mvsdk.CAMERA_MEDIA_TYPE_MONO8 else 3))

            # ç”±äºå·²ç»æ˜¯ 1080Pï¼Œå¦‚æœä¸éœ€è¦é¢å¤–ç¼©æ”¾ï¼Œå¯ä»¥ç›´æ¥ç”¨
            display_frame = cv2.resize(frame, DISPLAY_SIZE, interpolation=cv2.INTER_LINEAR)
            
            # å¸§ç‡
            fps_counter += 1
            current_time = time.time()
            if current_time - fps_start_time >= 1.0:
                current_fps = fps_counter / (current_time - fps_start_time)
                fps_counter = 0
                fps_start_time = current_time
                curr_exp = mvsdk.CameraGetExposureTime(hCamera) / 1000.0
                print(f"FPS: {current_fps:.1f} | Exp: {curr_exp:.1f}ms")
            
            fps_text = f"FPS: {current_fps:.1f}"
            cv2.putText(display_frame, fps_text, (10, 30), cv2.FONT_HERSHEY_SIMPLEX, 0.7, (0, 255, 0), 2)
            
            if is_recording:
                cv2.putText(display_frame, "REC", (DISPLAY_SIZE[0]-80, 30), cv2.FONT_HERSHEY_SIMPLEX, 0.7, (0, 0, 255), 2)
                cv2.circle(display_frame, (DISPLAY_SIZE[0]-40, 20), 8, (0, 0, 255), -1)

            cv2.imshow("Press q:Exit s:Rec e:Stop", display_frame)

            key = cv2.waitKey(1) & 0xFF
            if key == ord('s'):
                if not is_recording:
                    timestamp = datetime.datetime.now().strftime("%Y%m%d_%H%M%S")
                    output_filename = f"rec_{timestamp}.mp4"
                    # å½•åƒä½¿ç”¨è£å‰ªåçš„å®é™…åˆ†è¾¨ç‡
                    rec_fps = max(20, int(current_fps))
                    video_writer = cv2.VideoWriter(output_filename, cv2.VideoWriter_fourcc(*'mp4v'), 
                                                 rec_fps, (FrameHead.iWidth, FrameHead.iHeight))
                    if video_writer.isOpened():
                        is_recording = True
                        print(f"âœ… å¼€å§‹å½•åˆ¶: {output_filename} ({FrameHead.iWidth}x{FrameHead.iHeight})")

            elif key == ord('e'):
                if is_recording:
                    if video_writer: video_writer.release()
                    is_recording = False
                    print("â¹ï¸ åœæ­¢å½•åˆ¶")

            elif is_recording and video_writer:
                video_writer.write(frame)

        except mvsdk.CameraException as e:
            if e.error_code != mvsdk.CAMERA_STATUS_TIME_OUT:
                print("Error: {}".format(e.message))

    if is_recording and video_writer:
        video_writer.release()
    mvsdk.CameraUnInit(hCamera)
    mvsdk.CameraAlignFree(pFrameBuffer)

def main():
    try:
        main_loop()
    finally:
        cv2.destroyAllWindows()

if __name__ == "__main__":
    main()
