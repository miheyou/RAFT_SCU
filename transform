# coding=utf-8
import cv2
import numpy as np
import mvsdk
import platform
import datetime  # ç”¨äºç”Ÿæˆå¸¦æ—¶é—´æˆ³çš„æ–‡ä»¶å
import time     # ç”¨äºå¸§ç‡è®¡ç®—

def main_loop():
    # æšä¸¾ç›¸æœº
    DevList = mvsdk.CameraEnumerateDevice()
    nDev = len(DevList)
    if nDev < 1:
        print("No camera was found!")
        return

    for i, DevInfo in enumerate(DevList):
        print("{}: {} {}".format(i, DevInfo.GetFriendlyName(), DevInfo.GetPortType()))
    i = 0 if nDev == 1 else int(input("Select camera: "))
    DevInfo = DevList[i]
    print(DevInfo)

    # æ‰“å¼€ç›¸æœº
    hCamera = 0
    try:
        hCamera = mvsdk.CameraInit(DevInfo, -1, -1)
    except mvsdk.CameraException as e:
        print("CameraInit Failed({}): {}".format(e.error_code, e.message))
        return

    # è·å–ç›¸æœºç‰¹æ€§æè¿°
    cap = mvsdk.CameraGetCapability(hCamera)

    # åˆ¤æ–­æ˜¯é»‘ç™½ç›¸æœºè¿˜æ˜¯å½©è‰²ç›¸æœº
    monoCamera = (cap.sIspCapacity.bMonoSensor != 0)

    # é»‘ç™½ç›¸æœºè®©ISPç›´æ¥è¾“å‡ºMONOæ•°æ®
    if monoCamera:
        mvsdk.CameraSetIspOutFormat(hCamera, mvsdk.CAMERA_MEDIA_TYPE_MONO8)
    else:
        mvsdk.CameraSetIspOutFormat(hCamera, mvsdk.CAMERA_MEDIA_TYPE_BGR8)

    # ç›¸æœºæ¨¡å¼åˆ‡æ¢æˆè¿ç»­é‡‡é›†
    mvsdk.CameraSetTriggerMode(hCamera, 0)

    # ===== è‡ªåŠ¨æ›å…‰é…ç½® =====
    mvsdk.CameraSetAeState(hCamera, 1)
    # ç™½å¹³è¡¡
    mvsdk.CameraSetOnceWB(hCamera)

    # è®©SDKå†…éƒ¨å–å›¾çº¿ç¨‹å¼€å§‹å·¥ä½œ
    mvsdk.CameraPlay(hCamera)

    # è®¡ç®—bufferå¤§å°
    FrameBufferSize = cap.sResolutionRange.iWidthMax * \
        cap.sResolutionRange.iHeightMax * (1 if monoCamera else 3)

    # åˆ†é…RGB buffer
    pFrameBuffer = mvsdk.CameraAlignMalloc(FrameBufferSize, 16)

    # ==================== æ–°å¢ï¼šè§†é¢‘å½•åˆ¶ç›¸å…³å˜é‡ ====================
    is_recording = False                      # æ˜¯å¦æ­£åœ¨å½•åˆ¶
    output_filename = ""                      # è¾“å‡ºè§†é¢‘æ–‡ä»¶å
    
    # ==================== æ–°å¢ï¼šå¸§ç‡è®¡ç®—ç›¸å…³å˜é‡ ====================
    fps_counter = 0                           # å¸§è®¡æ•°å™¨
    fps_start_time = time.time()              # å¸§ç‡è®¡ç®—å¼€å§‹æ—¶é—´
    current_fps = 0                           # å½“å‰å¸§ç‡
    
    # æ˜¾ç¤ºçª—å£å¤§å°
    DISPLAY_SIZE = (800, 600)         # æ˜¾ç¤ºçª—å£å¤§å°

    while (cv2.waitKey(1) & 0xFF) != ord('q'):
        try:
            # 1. è·å–åŸå§‹Rawæ•°æ®
            pRawData, FrameHead = mvsdk.CameraGetImageBuffer(hCamera, 200)
            
            # 2. å¤„ç†Rawæ•°æ®åˆ°RGB Buffer
            mvsdk.CameraImageProcess(hCamera, pRawData, pFrameBuffer, FrameHead)
            
            # 3. é‡Šæ”¾Rawæ•°æ®Bufferï¼ˆå¿…é¡»å°½å¿«é‡Šæ”¾ï¼Œä»¥å…é˜»å¡é‡‡é›†ï¼‰
            mvsdk.CameraReleaseImageBuffer(hCamera, pRawData)

            # ==================== SDK å½•åƒæ ¸å¿ƒä»£ç  ====================
            # åœ¨å›¾åƒç¿»è½¬æˆ–è½¬æ¢ä¹‹å‰ï¼Œå°†å¤„ç†å¥½çš„RGBæ•°æ®æ¨é€åˆ°SDKå½•åƒé˜Ÿåˆ—
            if is_recording:
                # æ³¨æ„ï¼šCameraPushFrame å¿…é¡»æ¥æ”¶å¤„ç†åçš„ RGB buffer
                # å½•åˆ¶çš„åˆ†è¾¨ç‡ä¸ºç›¸æœºå½“å‰é‡‡é›†çš„åŸå§‹åˆ†è¾¨ç‡
                mvsdk.CameraPushFrame(hCamera, pFrameBuffer, FrameHead)
            # ========================================================

            # Windowsä¸‹é€šå¸¸éœ€è¦ç¿»è½¬å›¾åƒä»¥ä¾¿æ­£å¸¸æ˜¾ç¤º
            if platform.system() == "Windows":
                mvsdk.CameraFlipFrameBuffer(pFrameBuffer, FrameHead, 1)

            # 4. è½¬æ¢ä¸ºnumpyæ•°ç»„ (ä»…ç”¨äºOpenCVæ˜¾ç¤º)
            frame_data = (mvsdk.c_ubyte * FrameHead.uBytes).from_address(pFrameBuffer)
            frame = np.frombuffer(frame_data, dtype=np.uint8)
            frame = frame.reshape((FrameHead.iHeight, FrameHead.iWidth,
                                  1 if FrameHead.uiMediaType == mvsdk.CAMERA_MEDIA_TYPE_MONO8 else 3))

            # ç¼©æ”¾ç”¨äºæ˜¾ç¤º
            display_frame = cv2.resize(frame, DISPLAY_SIZE, interpolation=cv2.INTER_LINEAR)
            
            # ==================== å¸§ç‡è®¡ç®— ====================
            fps_counter += 1
            current_time = time.time()
            elapsed_time = current_time - fps_start_time
            
            # æ¯ç§’æ›´æ–°ä¸€æ¬¡å¸§ç‡
            if elapsed_time >= 1.0:
                current_fps = fps_counter / elapsed_time
                fps_counter = 0
                fps_start_time = current_time
            
            # åœ¨ç”»é¢ä¸Šæ˜¾ç¤ºä¿¡æ¯
            fps_text = f"FPS: {current_fps:.1f}"
            cv2.putText(display_frame, fps_text, (10, 30), 
                       cv2.FONT_HERSHEY_SIMPLEX, 0.7, (0, 255, 0), 2)
            
            # æ˜¾ç¤ºå½•åˆ¶çŠ¶æ€
            if is_recording:
                rec_text = "REC (SDK)"
                cv2.putText(display_frame, rec_text, (DISPLAY_SIZE[0]-150, 30), 
                           cv2.FONT_HERSHEY_SIMPLEX, 0.7, (0, 0, 255), 2)
                cv2.circle(display_frame, (DISPLAY_SIZE[0]-160, 20), 8, (0, 0, 255), -1)
            # =================================================

            cv2.imshow("Press q:Quit, s:Start Record, e:Stop Record", display_frame)

            key = cv2.waitKey(1) & 0xFF
            
            # ==================== æ§åˆ¶é€»è¾‘ ====================
            if key == ord('s'):  # å¼€å§‹å½•åˆ¶
                if not is_recording:
                    timestamp = datetime.datetime.now().strftime("%Y%m%d_%H%M%S")
                    # SDKå½•åƒé€šå¸¸å»ºè®®ä½¿ç”¨ .avi æ ¼å¼
                    output_filename = f"recording_{timestamp}.avi"
                    
                    # CameraInitRecord å‚æ•°è¯´æ˜:
                    # hCamera: ç›¸æœºå¥æŸ„
                    # iFormat: 1 (MSCVå‹ç¼©æ¨¡å¼ï¼Œæ–‡ä»¶è¾ƒå°), 0 (ä¸å‹ç¼©ï¼Œæ–‡ä»¶å·¨å¤§)
                    # pcSavePath: ä¿å­˜è·¯å¾„
                    # b2GLimit: 1 (è¶…è¿‡2Gè‡ªåŠ¨åˆ†å·), 0 (ä¸åˆ†å·)
                    # dwQuality: è§†é¢‘è´¨é‡ (1-100)
                    # iFrameRate: å½•åƒå¸§ç‡ (å»ºè®®è®¾ç½®ä¸ºå½“å‰å®é™…å¸§ç‡æˆ–30)
                    
                    rec_fps = int(current_fps) if current_fps > 0 else 25
                    err = mvsdk.CameraInitRecord(hCamera, 1, output_filename, 1, 80, rec_fps)
                    
                    if err == 0:
                        is_recording = True
                        print(f"âœ… SDKå½•åƒå·²å¯åŠ¨ï¼Œä¿å­˜ä¸º: {output_filename} (FPS: {rec_fps})")
                    else:
                        print(f"âŒ å½•åƒåˆå§‹åŒ–å¤±è´¥ï¼Œé”™è¯¯ç : {err}")
                        # å°è¯•è·å–é”™è¯¯æè¿°
                        print(f"   é”™è¯¯ä¿¡æ¯: {mvsdk.CameraGetErrorString(err)}")

            elif key == ord('e'):  # åœæ­¢å½•åˆ¶
                if is_recording:
                    mvsdk.CameraStopRecord(hCamera)
                    is_recording = False
                    print("â¹ï¸ SDKå½•åƒå·²åœæ­¢")

        except mvsdk.CameraException as e:
            if e.error_code != mvsdk.CAMERA_STATUS_TIME_OUT:
                print("CameraGetImageBuffer failed({}): {}".format(
                    e.error_code, e.message))

    # é‡Šæ”¾èµ„æº
    if is_recording:
        mvsdk.CameraStopRecord(hCamera)
        is_recording = False
        print("ğŸ›‘ ç¨‹åºé€€å‡ºå‰å·²å¼ºåˆ¶åœæ­¢å½•åˆ¶")

    mvsdk.CameraUnInit(hCamera)
    mvsdk.CameraAlignFree(pFrameBuffer)


def main():
    try:
        main_loop()
    finally:
        cv2.destroyAllWindows()

if __name__ == "__main__":
    main()
(raft_gpu) nvidia@nvidia:~/RAFT_life/CameraSDK_V2.1.0.49_0925/CameraSDK/demo/python_demo$ python3 cv_grab.py
0: MV-S2UC1606GC#0 USB3.0
acProductSeries:U3V
acProductName:MV-S2UC1606GC
acFriendlyName:MV-S2UC1606GC#0
acLinkName:MvCamera_f622_ca620
acDriverVersion:1.0.0.0
acSensorType:CMOS 16.0M
acPortType:USB3.0
acSn:045042620258
uInstance:0
âŒ å½•åƒåˆå§‹åŒ–å¤±è´¥ï¼Œé”™è¯¯ç : -4
   é”™è¯¯ä¿¡æ¯: ä¸æ”¯æŒè¯¥åŠŸèƒ½

